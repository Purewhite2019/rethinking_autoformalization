# Rethinking Statement Autoformalization
Official implementation for the paper:

**[ICLR'25 Spotlight] Rethinking and Improving Autoformalization: Towards a Faithful Metric and a Dependency Retrieval-based Approach**

Qi Liu, Xinhao Zheng, Xudong Lu, Qinxiang Cao*, Junchi Yan*â€ 

Sch. of Computer Science & Sch. of Artificial Intelligence, Shanghai Jiao Tong University

(*Equal correspondence. â€ Also affiliated with Shanghai Artificial Intelligence Laboratory.)

[ðŸ¤—Collection](https://huggingface.co/collections/purewhite42/rethinking-autoformalization-67bd7ed598805cb189f63e3d)
[ðŸ“ƒPaper](https://openreview.net/pdf?id=hUb2At2DsQ)

# Installation
## Python Dependencies
| **Name** Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | **Version** Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
|-----------------------------------------------------------------|------------------------------------------|
| [FlagEmbedding](https://github.com/FlagOpen/FlagEmbedding) Â  Â  Â | 76080ab83216d6d4156a597b220764a5bda45d92 |
| [Xtuner](https://github.com/InternLM/xtuner) Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | 0.1.23 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
## Lean 4 Dependencies
| **Name** Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | **Version** Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
|-----------------------------------------------------------------|------------------------------------------|
| [Lean 4](https://github.com/leanprover/lean4) Â  Â  Â  Â  Â  Â  Â  Â  | 4.7.0-rc2 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| [Mathlib 4](https://github.com/leanprover-community/mathlib4) | 59fdb6b04d7d16825a54483d550d9572ff473abf |
| [REPL](https://github.com/leanprover-community/repl) Â  Â  Â  Â  Â  Â | 2ab7948163863ee222891653ac98941fe4f20e87 |
| [ProofNet-lean4](https://github.com/rahul3613/ProofNet-lean4) Â  | 60efffb605ee07bf723db4fb8058129a7c8a89bb |
| [LeanDojo](https://github.com/lean-dojo/LeanDojo) Â  Â  Â  Â  Â  Â  Â  | 78cee9d37aa32e70cdd6119c4af70ae551b8b713 |
| [Con-NF](https://github.com/leanprover-community/con-nf) Â  Â  Â  Â | 16041ae6ea8b9a2ca79952afc7b927ccea18697b |
| [Doc-Gen 4](https://github.com/leanprover/doc-gen4) Â  Â  Â  Â  Â  | 780bbec107cba79d18ec55ac2be3907a77f27f98 |

# Dataset
## Autoformalization Benchmarks
Existing benchmarks (e.g., ProofNet, MiniF2F, PutnamBench) rely on Mathlib 4 and concentrate on high-school or undergraduate level mathematics.
To evaluate the out-of-distribution generalization capabilities and research-level mathematics, we build a novel autoformalization benchmark, **Con-NF**, based on [Lean 4 Con(NF)](https://github.com/leanprover-community/con-nf). This benchmark consists of 961 theorems based on a different theoretical basis than merely Mathlib 4, along with 1,348 formal objects and their informalizations. ([Sec.4.1](https://openreview.net/pdf?id=hUb2At2DsQ))

Both ProofNet and Con-NF are organized in `data/{connf, proofnet}/benchmark.jsonl`.

| **Field** Â  Â  Â  Â  Â  Â  Â  Â  Â | **Description** Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| ---------------------- | -------------------------------------------------------------- |
| `informal_stmt` Â  Â  Â  Â | Informal statement Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `formal_stmt` Â  Â  Â  Â  Â | Formal statement Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `header` Â  Â  Â  Â  Â  Â  Â  | Header of the formal statement (e.g. import, open) Â  Â  Â  Â  Â  Â  |
| `proof_state` Â  Â  Â  Â  Â | Initial proof state of the formal statement Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| `mathlib_dependencies` | Dependencies in imported libraries (not necessarily mathlib4!) |
| `hard_dependencies` Â  Â | Dependencies out of imported libraries Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `source` Â  Â  Â  Â  Â  Â  Â  | Source of the problem Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| `problem_name` Â  Â  Â  Â  | Original name of the problem Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `full_name` Â  Â  Â  Â  Â  Â | Full name of the problem (should be unique across benchmarks) Â |

## Human Equivalence Benchmark
To fairly and reliably evaluate automated metrics for statement autoformalization, we build the Human Equivalence Benchmark consisting of 200 typechecked model-generated formal statements with their ground-truth counterparts. ([Sec.3.3](https://openreview.net/pdf?id=hUb2At2DsQ))

This benchmark is in `data/human_equivalence/{o1-generated, rautoformalizer-generated}`, where
- `{o1-generated, rautoformalizer-generated}`: `o1-generated` denotes formal statements generated by OpenAI-o1-preview, Â `rautoformalizer-generated` denotes formal statements generated by an early version of RAutoformalizer;
- `autoformalization.json` organizes samples in the form of autoformalization results of the ProofNet benchmark (to facilitate evaluation);
- `labels.json` stores the human-annotated equivalence labels of each sample, where `true` means equivalent and `false` means inequivalent.

## Library
Formal objects (and their informal descriptions generated w/ **topological informalization**) are in `data/{connf, proofnet}/library.jsonl`. ([Sec.4.2](https://openreview.net/pdf?id=hUb2At2DsQ))

| **Field** Â  Â  Â  Â  Â  Â  | **Description** Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| ----------------- | ---------------------------------------------- |
| `full_name` Â  Â  Â  | Full name of the formal object Â  Â  Â  Â  Â  Â  Â  Â  |
| `url` Â  Â  Â  Â  Â  Â  | URL to the document page of the object Â  Â  Â  Â  |
| `code_src` Â  Â  Â  Â | Source of the object Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `ptype` Â  Â  Â  Â  Â  | Type of the object Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `header` Â  Â  Â  Â  Â | Declaration of the object Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| `code` Â  Â  Â  Â  Â  Â | Source code of the object Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
| `additional_info` | Additional information Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `used_premises` Â  | Dependency of the object Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
| `def_path` Â  Â  Â  Â | Path to the source file of the object Â  Â  Â  Â  Â |
| `pos` Â  Â  Â  Â  Â  Â  | Position of the source code in the source file |
| `informalization` | Informal description of the object Â  Â  Â  Â  Â  Â  |

# Reproduction
## Equivalence Metrics
### Evaluation of Human Equivalence Benchmark
| **Metric** Â  Â | **Precision** | **Recall** | **Accuracy** |
|---------------|---------------|------------|--------------|
| **Id Match** Â | 0/0 Â  Â  Â  Â  Â  | 0.00% Â  Â  Â | 65.00% Â  Â  Â  |
| **Typecheck** | 35.00% Â  Â  Â  Â | 100.00% Â  Â | 35.00% Â  Â  Â  |
| **BLEU** Â  Â  Â | 62.96% Â  Â  Â  Â | 24.29% Â  Â  | 68.50% Â  Â  Â  |
| **MajVot(I)** | 40.00% Â  Â  Â  Â | 94.29% Â  Â  | 48.50% Â  Â  Â  |
| **MajVot(D)** | 70.59% Â  Â  Â  Â | 85.71% Â  Â  | 82.50% Â  Â  Â  |
| **Def Equiv** | 100.00% Â  Â  Â  | 11.43% Â  Â  | 69.00% Â  Â  Â  |
| **Ours** Â  Â  Â | 100.00% Â  Â  Â  | 72.86% Â  Â  | 90.50% Â  Â  Â  |

The Human Equivalence Benchmark is organized as an autoformalization prediction on the ProofNet benchmark.
To evaluate it, please copy it to the output path. 
- **BEq** (_Bidirectional Extended Definitional Equivalence_)
```shell
export BEQ_LEVEL=... Â  Â # {basic, normal, advanced, all}
export EQ_BENCHMARK=... # {o1-generated, rautoformalizer-generated}
mkdir -p ./path/to/output/result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json /path/to/output/result && \
python -m equivalence.beq_${BEQ_LEVEL} \
    --port ... \ Â  Â # Can be arbitrarily set (should avoid conflict)
Â  Â  --trust-remote-code \
    --enable-prefix-caching \
Â  Â  --model /path/to/internlm2-math-plus-20b \ Â # Or other model
Â  Â  --mathlib_root /path/to/mathlib4 \
    --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root /path/to/output/results \
    --dataset_root ./data/ \
Â  Â  --repl_root /path/to/repl \
    --try_num 16 \
Â  Â  --num_concurrency 8 \
    --temperature 0.0
```
- Definitional Equality
```shell
export EQ_BENCHMARK=... # {o1-generated, rautoformalizer-generated}
mkdir -p ./path/to/output/result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json /path/to/output/result && \
python -m equivalence.def_eq \
    --mathlib_root /path/to/mathlib4 \
Â  Â  --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root /path/to/output/result \
    --dataset_root ./data/ \
Â  Â  --repl_root /path/to/repl
```
- Identity Matching
```shell
export EQ_BENCHMARK=... # {o1-generated, rautoformalizer-generated}
mkdir -p ./path/to/output/result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json ./path/to/output/result && \
python -m equivalence.id_match \
    --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root ./path/to/output/result \
    --dataset_root ./data/
```
## Dependency Retrieval
| **Bench** Â  Â  | **Fmt** | **Method** | **Recall@5** | **Precision@5** |
|---------------|---------|------------|--------------|-----------------|
| **ProofNet** | F Â  Â | BM25 Â  Â  Â  | 0.16% Â  Â  Â  Â | 0.11% Â  Â  Â  Â  Â  |
| Â  Â  Â  Â  Â  Â  Â  | F Â  Â | DR Â  Â  Â  Â  | 35.52% Â  Â  Â  | 22.89% Â  Â  Â  Â  Â |
| Â  Â  Â  Â  Â  Â  Â  | F+IF Â | BM25 Â  Â  Â  | 0.00% Â  Â  Â  Â | 0.00% Â  Â  Â  Â  Â  |
| Â  Â  Â  Â  Â  Â  Â  | F+IF Â | DR Â  Â  Â  Â  | 32.47% Â  Â  Â  | 20.32% Â  Â  Â  Â  Â |
| Â  **Con-NF** Â | F Â  Â | BM25 Â  Â  Â  | 4.41% Â  Â  Â  Â | 2.37% Â  Â  Â  Â  Â  |
| Â  Â  Â  Â  Â  Â  Â  | F Â  Â | DR Â  Â  Â  Â  | 24.32% Â  Â  Â  | 14.05% Â  Â  Â  Â  Â |
| Â  Â  Â  Â  Â  Â  Â  | F+IF Â | BM25 Â  Â  Â  | 9.86% Â  Â  Â  Â | 6.95% Â  Â  Â  Â  Â  |
| Â  Â  Â  Â  Â  Â  Â  | F+IF Â | DR Â  Â  Â  Â  | 27.91% Â  Â  Â  | 17.57% Â  Â  Â  Â  Â |
### BM25
- [ðŸ¤—`purewhite42/bm25_f`](https://huggingface.co/purewhite42/bm25_f): BM25 dependency retriever whose inputs are formatted using only formal declarations, based on [Rank-BM25](https://github.com/dorianbrown/rank_bm25)
- [ðŸ¤—`purewhite42/bm25_f_if`](https://huggingface.co/purewhite42/bm25_f_if): BM25 dependency retriever whose inputs are formatted using both formal declarations and informal descriptions, based on [Rank-BM25](https://github.com/dorianbrown/rank_bm25)
```shell
python -m retriever.retrieve_bm25 \
    --model_path /path/to/the/model \
    --save_path /path/to/output/results \
    --eval_set ... # {proofnet, connf}
```
### Dense Retrieval
- [ðŸ¤—`purewhite42/dependency_retriever_f`](https://huggingface.co/purewhite42/dependency_retriever_f): Dense dependency retriever whose inputs are formatted using only formal declarations, SFTed from [ðŸ¤—`BAAI/bge-m3`](https://huggingface.co/BAAI/bge-m3)
- [ðŸ¤—`purewhite42/dependency_retriever_f_if`](https://huggingface.co/purewhite42/dependency_retriever_f_if): Dense dependency retriever whose inputs are formatted using both formal declarations and informal descriptions, SFTed from [ðŸ¤—`BAAI/bge-m3`](https://huggingface.co/BAAI/bge-m3)
```shell
python -m retriever.retrieve_dr \
    --model_path /path/to/the/model \
    --save_path /path/to/output/results \
    --eval_set ... # {proofnet, connf}
```
## Autoformalization
| Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â  Â  **Benchmark** Â  Â | **ProofNet** | **Con-NF** |
|:---------------------:|:--------------------:|--------------|------------|
| **InternLM2-Math 7B** | Rautoformalizer (-R) | 16.58% Â  Â  Â  | 4.58% Â  Â  Â |
| Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | RAutoformalizer Â  Â  Â | 18.18% Â  Â  Â  | 16.86% Â  Â  |
| Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Rautoformalizer (+R) | 31.28% Â  Â  Â  | 55.36% Â  Â  |
| **DeepseekMath 7B** Â  | Rautoformalizer (-R) | 15.24% Â  Â  Â  | 4.27% Â  Â  Â |
| Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | RAutoformalizer Â  Â  Â | 17.91% Â  Â  Â  | 15.30% Â  Â  |
| Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Rautoformalizer (+R) | 32.62% Â  Â  Â  | 59.00% Â  Â  |
### w/o Dependency Retrieval
- [ðŸ¤—`purewhite42/rautoformalizer_nora_deepseek`](https://huggingface.co/purewhite42/rautoformalizer_nora_deepseek): w/o dependency retrieval, SFTed from [ðŸ¤—`deepseek-ai/deepseek-math-7b-base`](https://huggingface.co/deepseek-ai/deepseek-math-7b-base)
- [ðŸ¤—`purewhite42/rautoformalizer_nora_internlm`](https://huggingface.co/purewhite42/rautoformalizer_nora_internlm): w/o dependency retrieval, SFTed from [ðŸ¤—`internlm/internlm2-math-7b`](https://huggingface.co/internlm/internlm2-math-7b)

```shell
python -m autoformalizer.autoformalize_vllm_passk \
    --port ... \ Â  Â # Can be arbitrarily set (should avoid conflict)
Â  Â  --trust-remote-code \
    --enable-prefix-caching \
Â  Â  --model /path/to/model \
    --mathlib_root ... \ # Path to Mathlib 4 or path to Con(NF)
Â  Â  --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root /path/to/output/results \
    --dataset_root ./data/ \
Â  Â  --repl_root /path/to/repl \
    --try_num 8 \
Â  Â  --num_concurrency 8 \
    --temperature 0.0;
```
### RAutofromalizer (w/ Dependency Retrieval)
- [ðŸ¤—`purewhite42/rautoformalizer_ra_deepseek`](https://huggingface.co/purewhite42/rautoformalizer_ra_deepseek): w/ dependency retrieval (`dependency_retriever_f`), SFTed from [ðŸ¤—`deepseek-ai/deepseek-math-7b-base`](https://huggingface.co/deepseek-ai/deepseek-math-7b-base)
- [ðŸ¤—`purewhite42/rautoformalizer_ra_internlm`](https://huggingface.co/purewhite42/rautoformalizer_ra_internlm): w/ dependency retrieval (`dependency_retriever_f`), SFTed from [ðŸ¤—`internlm/internlm2-math-7b`](https://huggingface.co/internlm/internlm2-math-7b)
```shell
python -m autoformalizer.autoformalize_vllm_w_ra_passk \
    --port ... \ Â  Â # Can be arbitrarily set (should avoid conflict)
Â  Â  --trust-remote-code \
    --enable-prefix-caching \
Â  Â  --model /path/to/model \
    --retrieval_result_path /path/to/retrieval/result \
Â  Â  --mathlib_root ... \ # Path to Mathlib 4 or path to Con(NF)
Â  Â  --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root /path/to/output/results \
    --dataset_root ./data/ \
Â  Â  --repl_root /path/to/repl \
    --try_num 8 \
Â  Â  --num_concurrency 8 \
    --temperature 0.0;
```
### Oracle RAutoformalizer (w/ Ground-truth Dependencies)
- [ðŸ¤—`purewhite42/rautoformalizer_gtra_deepseek`](https://huggingface.co/purewhite42/rautoformalizer_gtra_deepseek): w/ oracle dependency retrieval, SFTed from [ðŸ¤—`deepseek-ai/deepseek-math-7b-base`](https://huggingface.co/deepseek-ai/deepseek-math-7b-base)
- [ðŸ¤—`purewhite42/rautoformalizer_gtra_internlm`](https://huggingface.co/purewhite42/rautoformalizer_gtra_internlm): w/ oracle dependency retrieval, SFTed from [ðŸ¤—`internlm/internlm2-math-7b`](https://huggingface.co/internlm/internlm2-math-7b)
```shell
python -m autoformalizer.autoformalize_vllm_w_gt_passk \
    --port ... \ Â  Â # Can be arbitrarily set (should avoid conflict)
Â  Â  --trust-remote-code \
    --enable-prefix-caching \
Â  Â  --model /path/to/model \
    --mathlib_root ... \ # Path to Mathlib 4 or path to Con(NF)
Â  Â  --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root /path/to/output/results \
    --dataset_root ./data/ \
Â  Â  --repl_root /path/to/repl \
    --try_num 8 \
Â  Â  --num_concurrency 8 \
    --temperature 0.0;
```
### Evaluation using BEq (Normal)
```shell
python -m equivalence.beq_normal \
    --port ... \ Â  Â # Can be arbitrarily set (should avoid conflict)
Â  Â  --trust-remote-code \
    --enable-prefix-caching \
Â  Â  --model /path/to/internlm2-math-plus-20b \
    --mathlib_root ... \ # Path to Mathlib 4 or path to Con(NF)
Â  Â  --eval_set ... \ Â  Â # {proofnet, connf}
Â  Â  --working_root /path/to/output/results \
    --dataset_root ./data/ \
Â  Â  --repl_root /path/to/repl \
    --try_num 8 \
Â  Â  --num_concurrency 8 \
    --temperature 0.0
```
# Citation
If you find our work useful in your research, please cite
```bibtex
@inproceedings{
liu2025rethinking,
title={Rethinking and improving autoformalization: towards a faithful metric and a Dependency Retrieval-based approach},
author={Qi Liu and Xinhao Zheng and Xudong Lu and Qinxiang Cao and Junchi Yan},
booktitle={The Thirteenth International Conference on Learning Representations},
year={2025},
url={https://openreview.net/forum?id=hUb2At2DsQ}
}
```

# License
This project is released under the Apache 2.0 license. Please see the [LICENSE](https://github.com/Purewhite2019/rethinking_autoformalization/blob/main/LICENSE) file for more information.

# Contact
Feel free to discuss the paper/data/code with us through issues/emails!
- Qi Liu: purewhite@sjtu.edu.cn
